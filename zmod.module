<?php
// $Id: zmod.module 10 2008-09-23 00:34:09Z pwolanin $
function zmod_block($op = 'list', $delta = '0', $edit = array()) {
  global $user;

  if ($op == 'list') {
    $blocks = array();
    $blocks['0']['info'] = t('User login/logout link');
    return $blocks;
  }
  elseif ($op == 'view') {
    $block = array();

    switch ($delta) {
      case '0':
        if (!$user->uid) {
          $block['subject'] = '';
          $block['content'] = l(t('Login / Register'), 'user/login', array('attributes' => array('id' => 'toggle-login')));

        }
        else {
          $block['subject'] = '';
          $block['content'] = check_plain($user->name) .' - '. l(t('Log out'), 'logout');
        }
        break;
    }
    return $block;
  }
}

function zmod_menu() {
  $items = array();

  return $items;
}

function zmod_nodeapi(&$node, $op, $teaser, $page) {
  switch ($op) {
    case 'view':
      if ($node->type == 'household') {
        $result = db_query(db_rewrite_sql("SELECT n.nid, n.title FROM {node} n JOIN {content_type_member} ctm ON ctm.vid = n.vid WHERE ctm.field_household_nid = %d AND n.status = 1"), $node->nid);
        $list = array();
        while ($m = db_fetch_array($result)) {
          $list[] = l($m['title'], 'node/' . $m['nid']);
        }
        $node->content['zmod_members_at_house'] = array(
          '#value' => '<h3>Members at this address:</h3>' . theme('item_list', $list),
          '#weight' => 100,
        );

      }
      break;

    case 'prepare':
      break;

    // Assign renewal date for updated member.
    case 'presave':
      if ($node->type == 'member') {
      }
      break;
  }
}

function zmod_init() {
  global $user;

  if (!$user->uid) {
    $data = 
"if (Drupal.jsEnabled) {
  (function($) {
    $(document).ready(function() {
    $('#block-user-0').hide();
    $('#toggle-login').click(function() {
      $('#block-user-0').slideToggle('fast');
      return false;
    });
  });
  })(jQuery);
}";
    drupal_add_js($data, 'inline');
  }
}